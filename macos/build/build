#!/bin/sh

# Copyright (c) 2013-2025, The PurpleI2P Project
# This file is part of Purple I2P project and licensed under BSD3
# See full license text in LICENSE file at top of project tree

set -e

dir=${0%/*}; [ "$dir" = "$0" ] && dir="."
cd "$dir"

# Locale: choose ru or en-US for the Firefox build to download
locale_raw="$(osascript -e 'user locale of (get system info)' 2>/dev/null || echo en_US)"
case "$(printf '%s' "$locale_raw" | tr '[:upper:]' '[:lower:]')" in
  ru* ) fx_lang="ru" ;;
  *   ) fx_lang="en-US" ;;
esac

: "${ESR_PRODUCT:=firefox-esr-latest}"

curl -V >/dev/null 2>&1 || { echo "'cURL' is required."; exit 1; }

echo "Preparing Firefox ESR for I2Pd..."
final_url=$(curl -s -L -I -o /dev/null -w '%{url_effective}' \
  "https://download.mozilla.org/?product=${ESR_PRODUCT}&os=osx&lang=${fx_lang}")
[ -n "$final_url" ] || { echo "[Error] Couldn't resolve Firefox URL."; exit 1; }

file=$(basename "$final_url")
echo "Downloading: $file"
curl -L -f -# -o "$file" "$final_url"

# Derive version from the DMG filename
version=$(printf "%s" "$file" | sed -E 's/^Firefox ([^ ]+)\.dmg$/\1/')
[ -n "$version" ] || { echo "[Error] Couldn't parse Firefox version."; exit 1; }

# Verify checksum against official mirror
ftpmirror="https://ftp.mozilla.org/pub/firefox/releases/${version}"
filepath="mac/${fx_lang}/${file// /%20}"

echo "Downloading SHA512SUMS and verifying..."
curl -L -f -# -O "${ftpmirror}/SHA512SUMS"
recv_sum=$(grep "mac/${fx_lang}/${file}" SHA512SUMS | cut -c-128)
file_sum=$(shasum -a 512 "$file" | cut -c-128)
[ "$recv_sum" = "$file_sum" ] || { echo "[Error] File checksum failed!"; rm -f SHA512SUMS; exit 1; }
rm -f SHA512SUMS
echo "Checksum OK."

echo "Attaching image and copying files..."
hdiutil attach "$file" -quiet
cp -r /Volumes/Firefox/Firefox.app ../FirefoxESR.app
mkdir -p ../data

echo "Detaching image and removing image file..."
hdiutil detach /Volumes/Firefox -quiet
rm -f "$file"

# Remove unneeded files
rm -rf ../FirefoxESR.app/Contents/Library
rm -rf ../FirefoxESR.app/Contents/MacOS/crashreporter.app
rm -f  ../FirefoxESR.app/Contents/MacOS/pingsender
rm -rf ../FirefoxESR.app/Contents/MacOS/updater.app
rm -f  ../FirefoxESR.app/Contents/Resources/browser/crashreporter-override.ini
rm -f  ../FirefoxESR.app/Contents/Resources/browser/features/formautofill@mozilla.org.xpi
rm -f  ../FirefoxESR.app/Contents/Resources/browser/features/screenshots@mozilla.org.xpi
rm -f  ../FirefoxESR.app/Contents/Resources/precomplete
rm -f  ../FirefoxESR.app/Contents/Resources/removed-files
rm -f  ../FirefoxESR.app/Contents/Resources/update*

# Disable updates
sed -i '' -e 's/Enabled=1/Enabled=0/g' "../FirefoxESR.app/Contents/Resources/application.ini" || true
sed -i '' -e 's/ServerURL=.*/ServerURL=-/' "../FirefoxESR.app/Contents/Resources/application.ini" || true

echo "Downloading language packs & dictionaries..."
mkdir -p ../FirefoxESR.app/Contents/Resources/browser/extensions

# Version-pinned language packs (match exact Firefox version)
xpi_base="https://releases.mozilla.org/pub/firefox/releases/${version}/mac/xpi"

# Always add RU so users can switch from EN
curl -L -f -# -o ../FirefoxESR.app/Contents/Resources/browser/extensions/langpack-ru@firefox.mozilla.org.xpi \
  "${xpi_base}/ru.xpi"

# Add en-US only if base build is RU
if [ "$fx_lang" = "ru" ]; then
  curl -L -f -# -o ../FirefoxESR.app/Contents/Resources/browser/extensions/langpack-en-US@firefox.mozilla.org.xpi \
    "${xpi_base}/en-US.xpi"
fi

# Dictionaries
curl -L -f -# -o ../FirefoxESR.app/Contents/Resources/browser/extensions/ru@dictionaries.addons.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/russian-spellchecking-dic-3703/latest.xpi"
curl -L -f -# -o ../FirefoxESR.app/Contents/Resources/browser/extensions/en-US@dictionaries.addons.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/english-us-dictionary/latest.xpi"

echo "Downloading NoScript..."
curl -L -f -# -o ../FirefoxESR.app/Contents/Resources/browser/extensions/{73a6fe31-595d-460b-a920-fcc0f8843232}.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/noscript/latest.xpi"

echo "Adding standard configs..."
cp -r preferences/* ../FirefoxESR.app/Contents/Resources/
cp -r profile/* ../data/
if [ "$fx_lang" = "ru" ]; then
  cp -r profile-ru/* ../data/
else
  cp -r profile-en/* ../data/
fi

# Launcher
cat > "../i2pdbrowser-portable" <<'EOF'
#!/bin/sh
dir=${0%/*}; [ "$dir" = "$0" ] && dir="."
cd "$dir"
FirefoxESR.app/Contents/MacOS/firefox -profile data -no-remote
EOF
chmod +x "../i2pdbrowser-portable"

echo "Downloading i2pd..."
i2pd_url=$(curl -s https://api.github.com/repos/PurpleI2P/i2pd/releases/latest | \
  grep -oE '"browser_download_url":\s*"[^"]+osx\.tar\.gz"' | sed -E 's/.*"([^"]+)".*/\1/' | head -n1)
[ -n "$i2pd_url" ] || { echo "[Error] Couldn't find i2pd osx tarball."; exit 1; }

curl -L -f -# -O "$i2pd_url"
mkdir -p ../i2pd
tar xfz "$(basename "$i2pd_url")" -C ../i2pd
mv ../i2pd/i2pd ../i2pd/i2pd-osx
cp -rf i2pd/* ../i2pd
rm -f "$(basename "$i2pd_url")"

echo "... finished"
