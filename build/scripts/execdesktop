#!/bin/bash

# See the LICENSE file at the top of the project tree for copyright and license details.

# This script extracts the I2Pd Browser startup program from the given file
# The program is specified in the line that starts with 'X-I2PdBrowser-ExecShell'
# The line is processed to remove the prefix and any trailing characters

set -Eeuo pipefail
trap 'echo "[Error] A problem occurred on line $LINENO." >&2' ERR

if [[ $# -lt 1 ]]; then
	echo "Usage: $0 <desktop-file> [args...]"
	exit 1
fi

desktop_file="$1"

# Extract the command from the desktop file
I2PDB_START_PROG="$(
	grep '^X-I2PdBrowser-ExecShell' "$desktop_file" | tail -1 \
		| sed 's/^X-I2PdBrowser-ExecShell=//' \
		| sed 's/%.//'
)"

# Discard the first parameter (the desktop file)
shift

# Announce launch
if [[ "$#" -ge 1 ]]; then
	echo "Launching '${I2PDB_START_PROG} $*'..."
else
	echo "Launching '${I2PDB_START_PROG}'..."
fi

# Execute the startup program with any additional arguments
# (Intentionally unquoted command to allow exec of a simple path; arguments remain quoted)
${I2PDB_START_PROG} "$@"
