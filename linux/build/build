#!/bin/sh

# Copyright (c) 2013-2025, The PurpleI2P Project
# This file is part of Purple I2P project and licensed under BSD3
# See full license text in LICENSE file at top of project tree

set -e

dir=${0%/*}; [ "$dir" = "$0" ] && dir="."
cd "$dir"

arch=$(uname -m)
language=$(printf "%s" "$LANG" | cut -c-5 | sed 's/_/-/g')
[ "$language" = "ru" ] || language="en-US"
: "${ESR_PRODUCT:=firefox-esr-latest}"

# Map architecture for redirector & checksums path
fx_os="linux64"; fx_dir="linux-x86_64"
case "$arch" in
  amd64|x86_64) fx_os="linux64"; fx_dir="linux-x86_64" ;;
  i?86)         fx_os="linux";   fx_dir="linux-i686"    ;;
  # (Optional) uncomment when Mozilla exposes aarch64 in redirector consistently
  # aarch64|arm64) fx_os="linux64"; fx_dir="linux-aarch64" ;;
esac

curl -V >/dev/null 2>&1 || { echo "'cURL' is required."; exit 1; }
command -v sha512sum >/dev/null || { echo "'sha512sum' is required."; exit 1; }

echo "Preparing Firefox ESR for I2Pd..."
final_url=$(curl -s -L -I -o /dev/null -w '%{url_effective}' \
  "https://download.mozilla.org/?product=${ESR_PRODUCT}&os=${fx_os}&lang=${language}")

[ -n "$final_url" ] || { echo "[Error] Couldn't resolve Firefox URL."; exit 1; }

file=$(basename "$final_url")
echo "Downloading Firefox: $file"
curl -L -f -# -O "$final_url"

# Extract version from filename
version=$(printf "%s" "$file" | sed -E 's/^firefox-([^.]*(\.[^.]*)*)\.(tar\.(bz2|xz))$/\1/')
ftpmirror="https://ftp.mozilla.org/pub/firefox/releases/${version}"
filepath="${fx_dir}/${language}/${file}"

echo "Downloading SHA512SUMS and verifying..."
curl -L -f -# -O "${ftpmirror}/SHA512SUMS"
recv_sum=$(grep " ${filepath}\$" SHA512SUMS | cut -c-128)
file_sum=$(sha512sum "$file" | cut -c-128)
[ "$recv_sum" = "$file_sum" ] || { echo "[Error] File checksum failed!"; exit 1; }
rm -f SHA512SUMS
echo "Checksum OK."

echo "Extracting..."
case "$file" in
  *.tar.xz) tar xJf "$file" ;;
  *.tar.bz2) tar xjf "$file" ;;
  *) tar xf "$file" ;;
esac
rm -f "$file"
mv firefox ../browser
mkdir -p ../browser/data

# Remove unneeded files
rm -f  ../browser/crashreporter* ../browser/minidump-analyzer ../browser/pingsender \
       ../browser/precomplete ../browser/removed-files ../browser/update*
rm -f  ../browser/Throbber-small.gif ../browser/browser/crashreporter-override.ini
rm -f  ../browser/browser/features/formautofill@mozilla.org.xpi \
       ../browser/browser/features/screenshots@mozilla.org.xpi
rm -rf ../browser/icons

# Tame updates
sed -i 's/Enabled=1/Enabled=0/g' ../browser/application.ini
sed -i 's/ServerURL=.*/ServerURL=-/' ../browser/application.ini

echo "Downloading language packs & dictionaries..."
mkdir -p ../browser/browser/extensions
curl -L -f -# -o ../browser/browser/extensions/langpack-ru@firefox.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/russian-ru-language-pack/latest.xpi"
curl -L -f -# -o ../browser/browser/extensions/langpack-en-US@firefox.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/english-us-language-pack/latest.xpi"
curl -L -f -# -o ../browser/browser/extensions/ru@dictionaries.addons.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/russian-spellchecking-dic-3703/latest.xpi"
curl -L -f -# -o ../browser/browser/extensions/en-US@dictionaries.addons.mozilla.org.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/english-us-dictionary/latest.xpi"

echo "Downloading NoScript (latest)..."
curl -L -f -# -o ../browser/browser/extensions/{73a6fe31-595d-460b-a920-fcc0f8843232}.xpi \
  "https://addons.mozilla.org/firefox/downloads/latest/noscript/latest.xpi"

echo "Adding standard configs..."
cp -r preferences/* ../browser/
cp -r profile/* ../browser/data/
if [ "$language" = "ru" ]; then
  cp -r profile-ru/* ../browser/data/
else
  cp -r profile-en/* ../browser/data/
fi

echo "Copying Desktop launch scripts..."
cp -r scripts/* ../browser/
cp scripts/start-i2pd-browser.desktop ../

echo "... finished"