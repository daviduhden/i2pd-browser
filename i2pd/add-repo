#!/usr/bin/bash
set -euo pipefail

# See the LICENSE file at the top of the project tree for copyright and license details.
#
# This script adds the Purple I2P APT repository.
# Supported:
#   - Debian 12 (bookworm), Debian 13 (trixie) and newer derivatives.
#   - Devuan 5 (daedalus), Devuan 6 (excalibur) (mapped to bookworm/trixie).
#   - Ubuntu 20.04 (focal), 22.04 (jammy), 24.04 (noble) and Ubuntu-like derivatives.
# Architectures: native amd64, i386, arm64, armhf only.

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "This script must be run as root"
    exit 1
fi

# Load system release information
if [[ -r /etc/os-release ]]; then
    # shellcheck disable=SC1091
    . /etc/os-release
else
    echo "Error: /etc/os-release not found. Cannot detect distribution."
    exit 1
fi

DIST="${ID:-}"
RELEASE=""
ARCH_FILTER=""

error() {
    echo "Error: $*" >&2
    exit 1
}

get_release() {
    case "$ID" in
        ###################################################################
        # Devuan support
        ###################################################################
        devuan)
            # Devuan uses its own codenames; map them to Debian codenames.
            #   Devuan 5 "daedalus"   -> Debian 12 "bookworm"
            #   Devuan 6 "excalibur"  -> Debian 13 "trixie"
            if [[ -z "${VERSION_CODENAME:-}" ]]; then
                error "Could not find VERSION_CODENAME in /etc/os-release on Devuan."
            fi

            case "$VERSION_CODENAME" in
                *daedalus*)
                    RELEASE="bookworm"
                    ;;
                *excalibur*)
                    RELEASE="trixie"
                    ;;
                *chimaera*)
                    error "Devuan chimaera (Debian 11) is not supported. Need Devuan daedalus or newer."
                    ;;
                *)
                    error "Unsupported Devuan version '${VERSION_CODENAME}'. Supported: daedalus and excalibur."
                    ;;
            esac

            # Use Debian repo layout for Devuan (packages are Debian-compatible).
            DIST="debian"
            ;;
        ###################################################################
        # Native Debian / Raspbian
        ###################################################################
        debian|raspbian)
            if [[ -n "${DEBIAN_CODENAME:-}" ]]; then
                RELEASE="$DEBIAN_CODENAME"
            elif [[ -n "${VERSION_CODENAME:-}" ]]; then
                RELEASE="$VERSION_CODENAME"
            else
                error "Couldn't find DEBIAN_CODENAME or VERSION_CODENAME in /etc/os-release."
            fi
            DIST="debian"
            ;;
        ###################################################################
        # Native Ubuntu
        ###################################################################
        ubuntu)
            if [[ -n "${UBUNTU_CODENAME:-}" ]]; then
                RELEASE="$UBUNTU_CODENAME"
            elif [[ -n "${VERSION_CODENAME:-}" ]]; then
                RELEASE="$VERSION_CODENAME"
            else
                error "Couldn't find UBUNTU_CODENAME or VERSION_CODENAME in /etc/os-release."
            fi
            DIST="ubuntu"
            ;;
        ###################################################################
        # Other Debian-/Ubuntu-like systems (derivatives)
        ###################################################################
        *)
            if [[ -z "${ID_LIKE:-}" ]]; then
                error "Your system is not supported. Only Debian-like and Ubuntu-like systems are supported."
            fi

            # Ubuntu-like derivative (e.g. Linux Mint, Pop!_OS, etc.)
            if [[ "$ID_LIKE" == *"ubuntu"* ]]; then
                DIST="ubuntu"
                if [[ -n "${UBUNTU_CODENAME:-}" ]]; then
                    RELEASE="$UBUNTU_CODENAME"
                elif [[ -n "${VERSION_CODENAME:-}" ]]; then
                    RELEASE="$VERSION_CODENAME"
                else
                    error "Couldn't find UBUNTU_CODENAME or VERSION_CODENAME for Ubuntu-like system."
                fi

            # Debian-like derivative (generic)
            elif [[ "$ID_LIKE" == *"debian"* ]]; then
                DIST="debian"
                if [[ -n "${DEBIAN_CODENAME:-}" ]]; then
                    RELEASE="$DEBIAN_CODENAME"
                elif [[ -n "${VERSION_CODENAME:-}" ]]; then
                    RELEASE="$VERSION_CODENAME"
                else
                    error "Couldn't find DEBIAN_CODENAME or VERSION_CODENAME for Debian-like system."
                fi

            else
                error "Your system is not supported. Only Debian-like and Ubuntu-like systems are supported."
            fi
            ;;
    esac

    if [[ -z "$RELEASE" ]]; then
        error "Couldn't detect a supported system release. This script supports Debian 12 (bookworm), Debian 13 (trixie), Devuan daedalus/excalibur, and Ubuntu focal/jammy/noble only."
    fi

    # Enforce minimum base release
    case "$RELEASE" in
        # Debian and derivatives (stable + newer branches)
        bookworm|trixie|forky|sid \
        # Ubuntu and derivatives (20.04+, 22.04, 24.04)
        |focal|jammy|noble)
            ;;
        *)
            error "Unsupported release codename '$RELEASE'. Supported Debian: bookworm, trixie; Ubuntu: focal, jammy, noble; and corresponding Devuan/derivatives."
            ;;
    esac
}

detect_arch_filter() {
    # Native architecture only
    local native
    native="$(dpkg --print-architecture 2>/dev/null || true)"

    if [[ -z "$native" ]]; then
        error "Could not detect native APT architecture."
    fi

    case "$native" in
        amd64|i386|arm64|armhf)
            ARCH_FILTER="$native"
            ;;
        *)
            error "Unsupported native architecture '$native'. This repo supports only amd64, i386, arm64, armhf."
            ;;
    esac
}

get_release
detect_arch_filter

echo "Detected distribution: $DIST"
echo "Detected release codename: $RELEASE"
echo "Using native APT architecture: $ARCH_FILTER"

echo "Importing signing key..."
install -d -m 0755 /usr/share/keyrings
wget -q -O- https://repo.i2pd.xyz/r4sas.gpg | gpg --dearmor > /usr/share/keyrings/purplei2p.gpg

echo "Adding APT repository..."
cat > /etc/apt/sources.list.d/purplei2p.list <<EOF
deb [arch=${ARCH_FILTER} signed-by=/usr/share/keyrings/purplei2p.gpg] https://repo.i2pd.xyz/$DIST $RELEASE main
# deb-src [arch=${ARCH_FILTER} signed-by=/usr/share/keyrings/purplei2p.gpg] https://repo.i2pd.xyz/$DIST $RELEASE main
EOF

echo "Done. You can now run: apt update && apt install i2pd"
